<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Mochiy+Pop+P+One&family=Shippori+Mincho:wght@500;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="style.css?v=2.8">
</head>

<body>
    <div class="app-container">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="app-header">
            <span id="app-version">v2.8 ï¼ˆæœ€çµ‚ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—æ—¥ï¼š2025/12/18ï¼‰</span>
            <h1 id="app-title">ã¾ãã¶ãƒ¼ã‚‰ã„ãµ</h1>
            <div id="header-controls" class="hidden">
                <button id="back-button" class="icon-button">
                    <span class="material-icons">arrow_back</span> æˆ»ã‚‹
                </button>
            </div>
        </header>

        <!-- ãƒ•ã‚§ãƒ¼ã‚º1: ãƒˆãƒƒãƒ—ç”»é¢ (ç¨®åˆ¥é¸æŠ) -->
        <main id="view-home" class="view active">
            <div class="category-group">
                <h2 class="category-title">å€Ÿã‚Šã‚‹</h2>
                <div class="button-grid">
                    <button class="type-btn" data-type="rent_residence" data-mode="rent">
                        <span class="icon">ğŸ </span>
                        <span class="label">ä½å±…ç”¨</span>
                    </button>
                    <button class="type-btn" data-type="rent_business" data-mode="rent">
                        <span class="icon">ğŸ¢</span>
                        <span class="label">äº‹æ¥­ç”¨</span>
                    </button>
                    <button class="type-btn" data-type="rent_land" data-mode="rent">
                        <span class="icon">ğŸŒ²</span>
                        <span class="label">åœŸåœ°</span>
                    </button>
                    <button class="type-btn" data-type="rent_parking" data-mode="rent">
                        <span class="icon">ğŸš—</span>
                        <span class="label">é§è»Šå ´</span>
                    </button>
                </div>
            </div>

            <div class="category-group">
                <h2 class="category-title">è²·ã†</h2>
                <div class="button-grid">
                    <button class="type-btn" data-type="buy_land" data-mode="buy">
                        <span class="icon">xim</span>
                        <span class="label">åœŸåœ°</span>
                    </button>
                    <button class="type-btn" data-type="buy_mansion" data-mode="buy">
                        <span class="icon">ğŸ¢</span>
                        <span class="label">ãƒãƒ³ã‚·ãƒ§ãƒ³</span>
                    </button>
                    <button class="type-btn" data-type="buy_house" data-mode="buy">
                        <span class="icon">ğŸ </span>
                        <span class="label">ä¸€æˆ¸å»ºã¦</span>
                    </button>
                    <button class="type-btn" data-type="buy_other" data-mode="buy">
                        <span class="icon">ğŸ’°</span>
                        <span class="label">åç›Šç‰©ä»¶ãƒ»ä»–</span>
                    </button>
                </div>
            </div>
        </main>

        <!-- ãƒ•ã‚§ãƒ¼ã‚º2: æ¤œç´¢æ¡ä»¶å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
        <main id="view-search" class="view">
            <h2 id="search-title" class="section-title">æ¡ä»¶è¨­å®š</h2>

            <!-- ä¿å­˜æ¸ˆã¿æ¡ä»¶ã‚¨ãƒªã‚¢ (New) -->
            <div id="saved-conditions-area" class="saved-area hidden">
                <p class="saved-label">ã‚ˆãä½¿ã†æ¡ä»¶ (ã‚¿ãƒƒãƒ—ã§å‘¼å‡º)</p>
                <div id="saved-tags" class="tags-container"></div>
            </div>

            <div class="form-container">
                <!-- ã‚¨ãƒªã‚¢é¸æŠ -->
                <div class="form-group">
                    <label>ã‚¨ãƒªã‚¢</label>
                    <select id="area-select">
                        <option value="naha">é‚£è¦‡å¸‚</option>
                        <option value="urasoe">æµ¦æ·»å¸‚</option>
                        <option value="ginowan">å®œé‡æ¹¾å¸‚</option>
                        <option value="okinawa">æ²–ç¸„å¸‚</option>
                        <option value="tomigusuku">è±Šè¦‹åŸå¸‚</option>
                        <option value="itoman">ç³¸æº€å¸‚</option>
                        <option value="nanjo">å—åŸå¸‚</option>
                        <option value="uruma">ã†ã‚‹ã¾å¸‚</option>
                        <option value="yonabaru">ä¸é‚£åŸç”º</option>
                        <option value="haebaru">å—é¢¨åŸç”º</option>
                        <option value="chatan">åŒ—è°·ç”º</option>
                        <option value="kadena">å˜‰æ‰‹ç´ç”º</option>
                        <option value="nishihara">è¥¿åŸç”º</option>
                    </select>
                </div>

                <!-- ä¾¡æ ¼/å®¶è³ƒé¸æŠ -->
                <div class="form-group">
                    <label id="price-label">ãŠå®¶è³ƒ</label>
                    <div class="price-range">
                        <select id="price-min"></select>
                        <span>ã€œ</span>
                        <select id="price-max"></select>
                    </div>
                </div>

                <!-- é–“å–ã‚Šé¸æŠ (æ¡ä»¶ã«ã‚ˆã‚Šè¡¨ç¤º/éè¡¨ç¤º) -->
                <div id="madori-group" class="form-group">
                    <label>é–“å–ã‚Š (è¤‡æ•°é¸æŠå¯)</label>
                    <div class="checkbox-grid">
                        <label class="checkbox-label"><input type="checkbox" name="madori" value="1r_1k"> 1R /
                            1K</label>
                        <label class="checkbox-label"><input type="checkbox" name="madori" value="1ldk_2k"> 1LDK /
                            2K</label>
                        <label class="checkbox-label"><input type="checkbox" name="madori" value="2ldk_3k"> 2LDK /
                            3K</label>
                        <label class="checkbox-label"><input type="checkbox" name="madori" value="3ldk_4k"> 3LDK /
                            4K</label>
                        <label class="checkbox-label"><input type="checkbox" name="madori" value="4ldk_over">
                            4LDKã€œ</label>
                    </div>
                </div>

                <!-- ãã®ä»–æ¡ä»¶ (New) -->
                <div id="other-conditions-group" class="form-group">
                    <label>ã“ã ã‚ã‚Šæ¡ä»¶</label>
                    <div class="checkbox-grid">
                        <label class="checkbox-label"><input type="checkbox" id="check-pet"> ãƒšãƒƒãƒˆå¯ ğŸ¶</label>
                        <label class="checkbox-label"><input type="checkbox" id="check-parking"> é§è»Šå ´ã‚ã‚Š ğŸš—</label>
                    </div>
                </div>

                <!-- ãƒ•ã‚§ãƒ¼ã‚º3: æ¤œç´¢å®Ÿè¡Œãƒœã‚¿ãƒ³ -->
                <div class="action-area">
                    <button id="search-button" class="primary-button">
                        æ¤œç´¢çµæœã‚’è¡¨ç¤º
                        <span class="material-icons">search</span>
                    </button>

                    <button id="save-current-btn" class="secondary-button">
                        ã“ã®æ¡ä»¶ã‚’ä¿å­˜ã™ã‚‹
                        <span class="material-icons">bookmark_add</span>
                    </button>

                    <!-- æ¤œç´¢çµæœãƒªãƒ³ã‚¯è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                    <div id="result-links" class="result-links-container hidden">
                        <h3>ä»¥ä¸‹ã®ãƒªãƒ³ã‚¯ã‹ã‚‰æ¤œç´¢çµæœã¸é£›ã¹ã¾ã™</h3>
                        <div id="links-list"></div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Feedback Section (New) -->
        <div class="feedback-section">
            <h3 class="feedback-title">ğŸ›  æ”¹å–„è¦æœ›ãƒ¡ãƒ¢</h3>
            <p class="feedback-desc">ã€Œã“ã“ã‚‚ã£ã¨ä½¿ã„ã‚„ã™ãã—ã¦ï¼ã€ãªã©ã®è¦æœ›ã‚’ãƒ¡ãƒ¢ã—ã¦ã€é–‹ç™ºè€…ã«é€ã£ã¦ã­ã€‚</p>
            <textarea id="feedback-input" placeholder="ä¾‹ï¼šæˆ»ã‚‹ãƒœã‚¿ãƒ³ãŒæŠ¼ã—ã«ãã„ã€ã€‡ã€‡ä¸å‹•ç”£ã‚‚è¿½åŠ ã—ã¦ã»ã—ã„..."></textarea>
            <div class="feedback-actions">
                <button id="save-feedback-btn" class="feedback-btn save">
                    <span class="material-icons" style="font-size:16px;">save</span> ä¸€æ™‚ä¿å­˜
                </button>
                <button id="send-feedback-btn" class="feedback-btn send">
                    <span class="material-icons" style="font-size:16px;">send</span> è¦æœ›ã‚’é€ã‚‹
                </button>
            </div>
        </div>

        <!-- Footer w/ Quotes -->
        <footer class="app-footer">
            <div class="quote-box">
                <p>ä»Šæ—¥ã®ä¸€è¨€</p>
                <p id="daily-quote">Loading...</p>
                <p id="quote-author"></p>
            </div>
        </footer>
    </div>

    <!-- Google Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script>
        // Safe DOM Ready Wrapper
        const initApp = () => {
            // --- Price Options Configuration (Moved to top) ---
            const RENT_PRICES = [
                { val: '0', label: 'ä¸‹é™ãªã—' },
                { val: '30000', label: '3ä¸‡å††' },
                { val: '40000', label: '4ä¸‡å††' },
                { val: '50000', label: '5ä¸‡å††' },
                { val: '60000', label: '6ä¸‡å††' },
                { val: '70000', label: '7ä¸‡å††' },
                { val: '80000', label: '8ä¸‡å††' },
                { val: '90000', label: '9ä¸‡å††' },
                { val: '100000', label: '10ä¸‡å††' },
                { val: '120000', label: '12ä¸‡å††' },
                { val: '150000', label: '15ä¸‡å††' },
                { val: '200000', label: '20ä¸‡å††' },
                { val: '99999999', label: 'ä¸Šé™ãªã—' }
            ];

            const BUY_PRICES = [
                { val: '0', label: 'ä¸‹é™ãªã—' },
                { val: '5000000', label: '500ä¸‡å††' },
                { val: '10000000', label: '1000ä¸‡å††' },
                { val: '15000000', label: '1500ä¸‡å††' },
                { val: '20000000', label: '2000ä¸‡å††' },
                { val: '25000000', label: '2500ä¸‡å††' },
                { val: '30000000', label: '3000ä¸‡å††' },
                { val: '40000000', label: '4000ä¸‡å††' },
                { val: '50000000', label: '5000ä¸‡å††' },
                { val: '80000000', label: '8000ä¸‡å††' },
                { val: '100000000', label: '1å„„å††' },
                { val: '9999999999', label: 'ä¸Šé™ãªã—' }
            ];

            // --- State Management ---
            const currentState = {
                mode: null,
                type: null,
                area: 'naha',
                priceMin: '0',
                priceMax: '0',
                madori: [],
                pet: false,
                parking: false
            };

            // --- DOM Elements ---
            const viewHome = document.getElementById('view-home');
            const viewSearch = document.getElementById('view-search');
            const headerControls = document.getElementById('header-controls');
            const backButton = document.getElementById('back-button');
            const typeButtons = document.querySelectorAll('.type-btn');

            // Header Elements
            const appTitle = document.getElementById('app-title');
            const searchTitle = document.getElementById('search-title');

            // Form Elements
            const priceLabel = document.getElementById('price-label');
            const priceMinSelect = document.getElementById('price-min');
            const priceMaxSelect = document.getElementById('price-max');
            const madoriGroup = document.getElementById('madori-group');
            const searchButton = document.getElementById('search-button');
            const areaSelect = document.getElementById('area-select');

            // --- Setup Logic ---
            function setupPriceOptions(mode) {
                if (!priceMinSelect || !priceMaxSelect) return;

                const options = (mode === 'rent') ? RENT_PRICES : BUY_PRICES;
                if (!options) return;

                // Helper to create options HTML
                const createOptionsHtml = (selectedVal) => {
                    let html = '';
                    for (let i = 0; i < options.length; i++) {
                        const opt = options[i];
                        const isSelected = opt.val === selectedVal ? 'selected' : '';
                        html += `<option value="${opt.val}" ${isSelected}>${opt.label}</option>`;
                    }
                    return html;
                };

                // Reset and populate
                priceMinSelect.innerHTML = createOptionsHtml('0');
                const defaultMax = (mode === 'rent') ? '99999999' : '9999999999';
                priceMaxSelect.innerHTML = createOptionsHtml(defaultMax);
            }

            typeButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const mode = btn.dataset.mode;
                    const type = btn.dataset.type;
                    const label = btn.querySelector('.label').textContent;
                    navigateToSearch(mode, type, label);
                });
            });

            backButton.addEventListener('click', () => {
                viewSearch.classList.remove('active');
                viewHome.classList.add('active');
                headerControls.classList.add('hidden');
                appTitle.textContent = 'ã¾ãã¶ãƒ¼ã‚‰ã„ãµ';
            });

            function navigateToSearch(mode, type, label) {
                try {
                    currentState.mode = mode;
                    currentState.type = type;

                    // UI Updates
                    viewHome.classList.remove('active');
                    viewSearch.classList.add('active');
                    headerControls.classList.remove('hidden');

                    const modeText = mode === 'rent' ? 'è³ƒè²¸' : 'å£²è²·';
                    appTitle.textContent = `ã€${modeText}ã€‘${label}`;
                    searchTitle.textContent = 'æ¡ä»¶è¨­å®š';
                    if (priceLabel) priceLabel.textContent = mode === 'rent' ? 'ãŠå®¶è³ƒ' : 'ä¾¡æ ¼';

                    // Configure Form
                    setupPriceOptions(mode);

                    // Toggle Madori visibility
                    if (type === 'rent_residence' || type === 'buy_mansion' || type === 'buy_house') {
                        madoriGroup.style.display = 'block';
                    } else {
                        madoriGroup.style.display = 'none';
                    }
                } catch (e) {
                    console.error('Navigation Error:', e);
                    alert('Error: ' + e.message);
                }
            }

            // --- Search Execution Logic ---
            const resultContainer = document.getElementById('result-links');
            const linksList = document.getElementById('links-list');

            searchButton.addEventListener('click', executeSearch);

            function executeSearch() {
                // Collect current values
                currentState.area = areaSelect.value;
                currentState.priceMin = priceMinSelect.value;
                currentState.priceMax = priceMaxSelect.value;

                // Madori collection
                const checkedMadori = Array.from(document.querySelectorAll('input[name="madori"]:checked')).map(cb => cb.value);
                currentState.madori = checkedMadori;

                // New conditions
                currentState.pet = document.getElementById('check-pet').checked;
                currentState.parking = document.getElementById('check-parking').checked;

                const urls = generateUrls(currentState);

                if (urls.length === 0) {
                    alert('URLç”Ÿæˆã‚¨ãƒ©ãƒ¼');
                    return;
                }

                // Render Links
                linksList.innerHTML = ''; // Clear previous
                urls.forEach((item) => {
                    const div = document.createElement('div'); // Create a container for link and warning
                    div.className = 'link-item-container';

                    const a = document.createElement('a');
                    a.href = item.url;
                    a.target = '_blank';
                    a.className = 'link-btn';

                    // Site Name + Icon (simple text for now)
                    a.innerHTML = `<span class="site-name">${item.name}</span> ã§è¦‹ã‚‹`;

                    div.appendChild(a); // Append link to the container

                    // Add Warning if needed
                    const warningText = getWarningMessage(item.id); // Use item.id (english) for logic
                    if (warningText) {
                        const warnP = document.createElement('p');
                        warnP.className = 'warning-text';
                        warnP.innerText = warningText;
                        warnP.style.color = '#e74c3c';
                        warnP.style.fontSize = '0.8rem';
                        warnP.style.marginTop = '4px';
                        div.appendChild(warnP); // Append warning to the container
                    }
                    linksList.appendChild(div); // Append the container to the list
                });

                // Show Container
                resultContainer.classList.remove('hidden');

                // Scroll to results
                resultContainer.scrollIntoView({ behavior: 'smooth' });
            }

            // --- URL Generator Functions ---
            // Note: Parameter mapping is estimated based on general knowledge to avoid scraping.
            // Real-world implementation requires precise parameter dictionaries.
            function generateUrls(state) {
                const urls = [];

                // 1. GooHome (æ²–ç¸„) -> ã‚°ãƒ¼ãƒ›ãƒ¼ãƒ 
                urls.push({ id: 'goohome', name: 'ã‚°ãƒ¼ãƒ›ãƒ¼ãƒ ', url: getGoohomeUrl(state) });

                // 2. Uchina Life (æ²–ç¸„) -> ã†ã¡ãªãƒ¼ã‚‰ã„ãµ
                urls.push({ id: 'uchina', name: 'ã†ã¡ãªãƒ¼ã‚‰ã„ãµ', url: getUchinaUrl(state) });

                // 3. SUUMO (å…¨å›½) -> SUUMO (Keep as is or Katakana? User didn't specify, likely standard)
                urls.push({ id: 'suumo', name: 'SUUMO', url: getSuumoUrl(state) });

                // 4. AtHome (å…¨å›½) -> ã‚¢ãƒƒãƒˆãƒ›ãƒ¼ãƒ 
                urls.push({ id: 'athome', name: 'ã‚¢ãƒƒãƒˆãƒ›ãƒ¼ãƒ ', url: getAthomeUrl(state) });

                // 5. LIFULL HOME'S (å…¨å›½) -> ãƒ›ãƒ¼ãƒ ã‚º
                urls.push({ id: 'homes', name: 'ãƒ›ãƒ¼ãƒ ã‚º', url: getHomesUrl(state) });

                return urls;
            }

            // --- Site Specific Logic ---

            /* City Code Mapping */
            // SUUMO: Naha=47201
            // Goohome: Naha=naha
            const CITY_CODES = {
                naha: { name: 'é‚£è¦‡å¸‚', goo: 'naha', uchina: 'nahashi', suumo_sc: '47201', athome: 'naha-city' },
                urasoe: { name: 'æµ¦æ·»å¸‚', goo: 'urasoe', uchina: 'urasoeshi', suumo_sc: '47208', athome: 'urasoe-city' },
                ginowan: { name: 'å®œé‡æ¹¾å¸‚', goo: 'ginowan', uchina: 'ginowanshi', suumo_sc: '47205', athome: 'ginowan-city' },
                okinawa: { name: 'æ²–ç¸„å¸‚', goo: 'okinawa', uchina: 'okinawashi', suumo_sc: '47211', athome: 'okinawa-city' },
                tomigusuku: { name: 'è±Šè¦‹åŸå¸‚', goo: 'tomigusuku', uchina: 'tomigusukushi', suumo_sc: '47212', athome: 'tomigusuku-city' },
                itoman: { name: 'ç³¸æº€å¸‚', goo: 'itoman', uchina: 'itomanshi', suumo_sc: '47210', athome: 'itoman-city' },
                nanjo: { name: 'å—åŸå¸‚', goo: 'nanjo', uchina: 'nanjoshi', suumo_sc: '47215', athome: 'nanjo-city' },
                uruma: { name: 'ã†ã‚‹ã¾å¸‚', goo: 'uruma', uchina: 'urumashi', suumo_sc: '47213', athome: 'uruma-city' },
            };

            function getCityData(cityKey) {
                return CITY_CODES[cityKey] || CITY_CODES['naha'];
            }

            function getWarningMessage(siteName) {
                const warnings = [];
                const lowerSiteName = siteName.toLowerCase();

                // ã‚µã‚¤ãƒˆã”ã¨ã®æ¤œç´¢æ¡ä»¶åæ˜ çŠ¶æ³å®šç¾©
                // GooHome: ãƒšãƒƒãƒˆ(shubetsu=pet), é§è»Šå ´(parking=1) -> OK
                // Uchina: ãƒšãƒƒãƒˆ(feature=ãƒšãƒƒãƒˆå¯) -> OK, é§è»Šå ´ -> æœªå¯¾å¿œ(GET)
                // Others: åŸºæœ¬çš„ã«è©³ç´°æ¡ä»¶ã¯URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§æ¸¡ã›ãªã„(ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å¯¾ç­–ç­‰ã§è¤‡é›‘ãªãŸã‚)

                if (lowerSiteName === 'athome' || lowerSiteName === 'homes' || lowerSiteName === 'suumo') {
                    if (currentState.pet) warnings.push('ãƒšãƒƒãƒˆå¯');
                    if (currentState.parking) warnings.push('é§è»Šå ´');
                } else if (lowerSiteName === 'uchina') {
                    if (currentState.parking) warnings.push('é§è»Šå ´');
                }

                if (warnings.length > 0) {
                    return `â€»æ¡ä»¶æœªåæ˜ : ${warnings.join('ãƒ»')} (ã‚µã‚¤ãƒˆå´ã§æŒ‡å®šã—ã¦ãã ã•ã„)`;
                }
                return '';
            }

            function getGoohomeUrl(state) {
                // GooHome Verified: https://goohome.jp/chintai/mansion/naha/?price=-60000&madori=104
                // Pet: &shubetsu=pet
                // Parking: &parking=1

                const city = getCityData(state.area).goo;
                let url = `https://goohome.jp/${state.mode === 'rent' ? 'chintai/mansion' : 'bai-bai/mansion'}/${city}/`;

                const params = [];
                if (state.mode === 'rent' && state.priceMax !== '0' && !state.priceMax.startsWith('9')) {
                    params.push(`price=-${state.priceMax}`);
                }

                // Madori mapping based on investigation
                if (state.madori.includes('1ldk_2k')) {
                    params.push('madori=104');
                }

                // New Conditions
                if (state.pet) params.push('shubetsu=pet');
                if (state.parking) params.push('parking=1');

                if (params.length > 0) url += `?${params.join('&')}`;
                return url;
            }

            function getUchinaUrl(state) {
                // Uchina is verified working with params
                const city = getCityData(state.area).uchina;
                let url = `https://www.e-uchina.net/jukyo/${city}`;
                const params = [];

                if (state.mode === 'rent') {
                    if (state.priceMax !== '0' && !state.priceMax.startsWith('9')) {
                        params.push(`priceHigh=${parseInt(state.priceMax) / 10000}`);
                    }
                    if (state.madori.includes('1ldk_2k')) {
                        params.push('madori=1LDK');
                    }
                    if (state.pet) {
                        params.push('feature=ãƒšãƒƒãƒˆå¯');
                    }
                    // Parking is not directly supported via simple GET param for Uchina, will be warned.
                }
                if (params.length > 0) url += `?${params.join('&')}`;
                return url;
            }

            function getSuumoUrl(state) {
                // SUUMO: Verified with full base params.
                // https://suumo.jp/jj/chintai/ichiran/FR301FC001/?ar=090&bs=040&ta=47&sc=47201&ct=6.0

                if (state.mode !== 'rent') {
                    return `https://suumo.jp/jj/buy/ichiran/FR301FC001/?ar=090&bs=021&ta=47&sc=${getCityData(state.area).suumo_sc}`;
                }

                const citySc = getCityData(state.area).suumo_sc;
                const prices = {
                    '0': '9999999',
                    '30000': '3.0',
                    '40000': '4.0',
                    '50000': '5.0',
                    '60000': '6.0',
                    '70000': '7.0',
                    '80000': '8.0',
                    '90000': '9.0',
                    '100000': '10.0',
                    '120000': '12.0',
                    '150000': '15.0',
                    '200000': '20.0',
                    '99999999': '9999999'
                };

                const rentParam = prices[state.priceMax] || '9999999';

                // SUUMO: tc=0400301 (Pet), tc=0400101 (Parking) - Hypothetical codes need verification, 
                // but often Suumo uses checkbox parameters.
                // For this demo, let's assume we can't easily inject these without accurate codes.
                // We will warn for Suumo too to be safe, OR try common ones.
                // Let's TRY adding commonly found params, but if fails, user can refine.

                let url = `https://suumo.jp/jj/chintai/ichiran/FR301FC001/?ar=090&bs=040&ta=47&sc=${citySc}&ct=${rentParam}`;

                // Simple append for demo (Suumo codes are complex, safe to warn if unsure)
                // If we can't guarantee, we might want to warn. 
                // Let's add them to warning for Suumo for now to ensure user knows to check.
                // Pet and Parking are handled by getWarningMessage for SUUMO.


                return url;
            }

            function getAthomeUrl(state) {
                // AtHome: Defaults to city list for safety.
                const city = getCityData(state.area).athome;
                return `https://www.athome.co.jp/${state.mode === 'rent' ? 'chintai' : 'kodate'}/okinawa/${city}/list/`;
            }

            function getHomesUrl(state) {
                // Homes: Defaults to city list for safety.
                // Verified `cond[money_room_h]` injection causes 404 in some contexts.
                const city = getCityData(state.area).athome; // Borrow slug
                return `https://www.homes.co.jp/${state.mode === 'rent' ? 'chintai' : 'kodate'}/okinawa/${city}/list/`;
            }

            // --- LocalStorage Favorites ---
            const STORAGE_KEY = 'okinawa_housing_favs';
            const savedConditionsArea = document.getElementById('saved-conditions-area');
            const savedTagsContainer = document.getElementById('saved-tags');
            const saveCurrentBtn = document.getElementById('save-current-btn');

            // Load saved data on init
            renderSavedTags();

            // Save Button Handler
            if (saveCurrentBtn) {
                saveCurrentBtn.addEventListener('click', () => {
                    // Force update state from DOM first!
                    currentState.area = areaSelect.value;
                    currentState.priceMin = priceMinSelect.value;
                    currentState.priceMax = priceMaxSelect.value;
                    currentState.madori = Array.from(document.querySelectorAll('input[name="madori"]:checked')).map(cb => cb.value);
                    currentState.pet = document.getElementById('check-pet').checked;
                    currentState.parking = document.getElementById('check-parking').checked;

                    const name = prompt('ã“ã®æ¤œç´¢æ¡ä»¶ã«åå‰ã‚’ä»˜ã‘ã¦ä¿å­˜ï¼š', stateToDefaultName());
                    if (name === null) return; // Cancelled
                    if (name.trim() === '') return; // Empty

                    const favs = getFavs();
                    const favorite = {
                        name: name,
                        mode: currentState.mode,
                        type: currentState.type,
                        area: currentState.area,
                        priceMin: currentState.priceMin,
                        priceMax: currentState.priceMax,
                        madori: currentState.madori,
                        pet: currentState.pet,
                        parking: currentState.parking
                    };

                    favs.push(favorite); // Changed currentData to favorite
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(favs));

                    renderSavedTags();
                    alert(`ã€Œ${name}ã€ã‚’ä¿å­˜ã—ã¾ã—ãŸ\næ¬¡å›ã‹ã‚‰ä¸Šéƒ¨ã®ãƒœã‚¿ãƒ³ã§å‘¼ã³å‡ºã›ã¾ã™`);
                });
            }

            function stateToDefaultName() {
                const areaName = areaSelect.options[areaSelect.selectedIndex].text;
                return `${areaName}ã®æ¡ä»¶`;
            }

            function getFavs() {
                const raw = localStorage.getItem(STORAGE_KEY);
                return raw ? JSON.parse(raw) : [];
            }

            function renderSavedTags() {
                const favs = getFavs();

                if (favs.length === 0) {
                    savedConditionsArea.classList.add('hidden');
                    return;
                }

                savedConditionsArea.classList.remove('hidden');
                savedTagsContainer.innerHTML = '';

                favs.forEach((fav, index) => {
                    const tag = document.createElement('button');
                    tag.className = 'saved-tag';
                    tag.innerHTML = `<span class="tag-name">${fav.name}</span><span class="delete-tag" data-index="${index}">Ã—</span>`;

                    // Load fav on click (ignore delete btn click)
                    tag.addEventListener('click', (e) => {
                        if (e.target.classList.contains('delete-tag')) {
                            deleteFav(index);
                        } else {
                            loadFav(fav);
                        }
                    });

                    savedTagsContainer.appendChild(tag);
                });
            }

            function deleteFav(index) {
                if (!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
                const favs = getFavs();
                favs.splice(index, 1);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(favs));
                renderSavedTags();
            }

            function loadFav(fav) {
                // 1. Restore Mode/Type Context first
                const savedMode = fav.mode;
                const savedType = fav.type;
                const savedName = fav.name || 'ä¿å­˜ã•ã‚ŒãŸæ¡ä»¶';

                if (savedMode && savedType) {
                    // This function sets up the form options (setupPriceOptions) and visible fields
                    navigateToSearch(savedMode, savedType, savedName);
                }

                // 2. Apply values (Now that options are built for the correct mode)
                if (fav.area) areaSelect.value = fav.area;

                // Timeout optional but safe for rendering, sticking to sync for now.
                if (fav.priceMin) priceMinSelect.value = fav.priceMin;
                if (fav.priceMax) priceMaxSelect.value = fav.priceMax;

                // 3. Apply checkboxes
                // First uncheck all to start fresh
                document.querySelectorAll('input[name="madori"]').forEach(cb => cb.checked = false);

                if (fav.madori && Array.isArray(fav.madori)) {
                    document.querySelectorAll('input[name="madori"]').forEach(cb => {
                        if (fav.madori.includes(cb.value)) cb.checked = true;
                    });
                }

                // 4. Update Global CurrentState to match visual state
                currentState.mode = savedMode;
                currentState.type = savedType;
                currentState.area = areaSelect.value;
                currentState.priceMin = priceMinSelect.value;
                currentState.priceMax = priceMaxSelect.value;
                currentState.madori = fav.madori || [];
                currentState.pet = fav.pet || false;
                currentState.parking = fav.parking || false;

                // Restore checkboxes
                document.getElementById('check-pet').checked = currentState.pet;
                document.getElementById('check-parking').checked = currentState.parking;

                // Scroll to search button
                searchButton.scrollIntoView({ behavior: 'smooth' });

                // Highlight effect
                document.querySelector('.form-container').animate([
                    { transform: 'scale(1)' },
                    { transform: 'scale(1.02)' },
                    { transform: 'scale(1)' }
                ], { duration: 300 });
            }

            // --- Quote of the Day ---
            const quotes = [
                { text: "å…ƒæ°—ãŒã‚ã‚Œã°ä½•ã§ã‚‚ã§ãã‚‹ï¼", author: "ã‚¢ãƒ³ãƒˆãƒ‹ã‚ªçŒªæœ¨" },
                { text: "è¿·ã‚ãšè¡Œã‘ã‚ˆ è¡Œã‘ã°ã‚ã‹ã‚‹ã•", author: "ã‚¢ãƒ³ãƒˆãƒ‹ã‚ªçŒªæœ¨" },
                { text: "å‹ã¡ã«ä¸æ€è­°ã®å‹ã¡ã‚ã‚Šã€è² ã‘ã«ä¸æ€è­°ã®è² ã‘ãªã—", author: "é‡æ‘å…‹ä¹Ÿ" },
                { text: "ãƒãƒ¼å›ã€ç¥ã®å­ã€ä¸æ€è­°ãªå­", author: "é‡æ‘å…‹ä¹Ÿ" },
                { text: "è«¦ã‚ã‚“ãªã‚ˆï¼è«¦ã‚ã‚“ãªã‚ˆã€ãŠå‰ï¼ï¼", author: "æ¾å²¡ä¿®é€ " },
                { text: "ä¸€ç•ªã«ãªã‚‹ã¨è¨€ã£ãŸã‚ï¼å¯Œå£«å±±ã®ã‚ˆã†ã«æ—¥æœ¬ä¸€ã«ãªã‚‹ã‚“ã ã‚ˆï¼", author: "æ¾å²¡ä¿®é€ " },
                { text: "åŠªåŠ›ã¯å¿…ãšå ±ã‚ã‚Œã‚‹ã€‚ã‚‚ã—å ±ã‚ã‚Œãªã„åŠªåŠ›ãŒã‚ã‚‹ã®ãªã‚‰ã°ã€ãã‚Œã¯ã¾ã åŠªåŠ›ã¨å‘¼ã¹ãªã„ã€‚", author: "ç‹è²æ²»" },
                { text: "æ•µã¯å·±ã®ä¸­ã«ã‚ã‚Š", author: "ç‹è²æ²»" },
                { text: "å°ã•ã„ã“ã¨ã‚’ç©ã¿é‡ã­ã‚‹ã®ãŒã€ã¨ã‚“ã§ã‚‚ãªã„ã¨ã“ã‚ã¸è¡ŒããŸã ã²ã¨ã¤ã®é“", author: "ã‚¤ãƒãƒ­ãƒ¼" },
                { text: "å£ã¨ã„ã†ã®ã¯ã€ã§ãã‚‹äººã«ã—ã‹ã‚„ã£ã¦ã“ãªã„", author: "ãƒ€ãƒ«ãƒ“ãƒƒã‚·ãƒ¥æœ‰" }
            ];

            function displayDailyQuote() {
                const quoteEl = document.getElementById('daily-quote');
                const authorEl = document.getElementById('quote-author');
                if (!quoteEl || !authorEl) return;

                // Use Date to select a quote that changes every 24 hours
                // Offset by timezone if strictly needed, but simple local date is fine for client-side
                const start = new Date(2025, 0, 1); // Epoch for this app
                const now = new Date();
                const diff = now - start;
                const oneDay = 1000 * 60 * 60 * 24;
                const dayIndex = Math.floor(diff / oneDay);

                const quote = quotes[Math.abs(dayIndex % quotes.length)];

                quoteEl.innerText = `ã€Œ${quote.text}ã€`;
                authorEl.innerText = `- ${quote.author}`;
            }

            // Init Quote
            displayDailyQuote();

            // --- VISUAL READY INDICATOR ---
            document.getElementById('app-version').style.color = 'rgba(255,255,255,0.8)'; // Reset color
            document.getElementById('app-version').textContent = 'v2.8 ï¼ˆæœ€çµ‚ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—æ—¥ï¼š2025/12/18ï¼‰';

            // --- FEEDBACK LOGIC ---
            const feedbackInput = document.getElementById('feedback-input');
            const saveFeedbackBtn = document.getElementById('save-feedback-btn');
            const sendFeedbackBtn = document.getElementById('send-feedback-btn');
            const FEEDBACK_KEY = 'okinawa_housing_feedback_draft';

            // Load Draft
            const savedFeedback = localStorage.getItem(FEEDBACK_KEY);
            if (savedFeedback) {
                feedbackInput.value = savedFeedback;
            }

            // Save Draft Action
            saveFeedbackBtn.addEventListener('click', () => {
                const content = feedbackInput.value;
                localStorage.setItem(FEEDBACK_KEY, content);
                alert('ãƒ¡ãƒ¢ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¸€æ™‚ä¿å­˜ã—ã¾ã—ãŸï¼\nï¼ˆã¾ã é€ä¿¡ã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼‰');
            });

            // Send Action
            sendFeedbackBtn.addEventListener('click', () => {
                const content = feedbackInput.value;
                if (!content.trim()) {
                    alert('å†…å®¹ãŒç©ºã§ã™ï¼');
                    return;
                }

                // Save before sending
                localStorage.setItem(FEEDBACK_KEY, content);

                // Create Mailto
                const subject = encodeURIComponent('ã¾ãã¶ãƒ¼ã‚‰ã„ãµæ”¹å–„è¦æœ›');
                const body = encodeURIComponent(`ã€è¦æœ›å†…å®¹ã€‘\n${content}\n\nSent from ã¾ãã¶ãƒ¼ã‚‰ã„ãµ`);

                // User hasn't provided email, so we leave 'to' blank or ask user to fill it.
                // Or we can use a "Copy to Clipboard" approach which is often safer for LINE/DM.
                // Let's offer a choice or just open mailer.
                const mailtoLink = `mailto:?subject=${subject}&body=${body}`;
                window.location.href = mailtoLink;
            });
        };

        // --- Bootloader ---
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }
    </script>
</body>

</html>